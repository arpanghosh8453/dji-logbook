{
  "project": {
    "name": "DJI Log Viewer",
    "goal": "Local-first DJI flight log viewer with charts, maps, and analytics.",
    "stack": {
      "desktop": "Tauri v2",
      "frontend": "React 18 + TypeScript + Vite + Tailwind",
      "state": "Zustand",
      "charts": "ECharts (echarts-for-react)",
      "maps": "MapLibre GL (react-map-gl) + deck.gl",
      "database": "DuckDB (duckdb-rs, bundled)",
      "parser": "dji-log-parser v0.5.7"
    },
    "os": "Linux",
    "runtime": {
      "node": "18.x",
      "rust": "stable",
      "tauri_cli": "2.x"
    }
  },
  "dependencies": {
    "frontend": {
      "react": "^18.3.1",
      "react_dom": "^18.3.1",
      "vite": "^6.0.0",
      "tailwindcss": "^3.4.14",
      "zustand": "^5.0.0",
      "echarts": "^5.5.0",
      "echarts_for_react": "^3.0.2",
      "react_map_gl": "^7.1.7",
      "maplibre_gl": "^4.7.0",
      "deck_gl": "^9.x",
      "deck_gl_layers": "^9.x",
      "react_dropzone": "^14.3.5",
      "react_day_picker": "^9.13.0"
    },
    "tauri_plugins": [
      "@tauri-apps/api",
      "@tauri-apps/plugin-dialog",
      "@tauri-apps/plugin-fs",
      "@tauri-apps/plugin-log",
      "@tauri-apps/plugin-shell"
    ],
    "backend": {
      "duckdb_rs": "bundled",
      "dji_log_parser": "0.5.7",
      "tempfile": "3 (dev-dependency for tests)"
    }
  },
  "scope": {
    "features": [
      "Import and parse DJI flight logs (bulk import with cooldown).",
      "Local DuckDB storage with telemetry schema, WAL recovery, and migration support.",
      "Overview analytics page (totals, averages, max altitude, max distance from home).",
      "Overview activity heatmap (365-day, 7x52 grid).",
      "Overview donut charts for flights by drone model and batteries used.",
      "Overview top 3 longest and furthest (distance-from-home) flights.",
      "Battery health: per-serial health bars and per-minute usage history plot (scatter + smoothed line).",
      "Flight list with rename, delete, filters (date range, drone, battery), search, and sorting.",
      "Settings: API key, units (metric/imperial), theme (light/dark/system), delete-all logs.",
      "Settings: shows app data + log directory for troubleshooting.",
      "Charts: height/VPS/speed (metric in km/h), battery, attitude, RC signal, GPS satellites.",
      "Charts: RC uplink/downlink, distance-to-home, velocity X/Y/Z.",
      "Charts: synchronized zoom, reset zoom, auto-scaled Y axes, aligned X-axis ticks, custom tooltip header with pills.",
      "Map: 3D terrain view via MapLibre, global theme styling.",
      "Map: satellite style toggle, gradient flight path with start/end markers.",
      "Map: deck.gl 3D path overlay; map toggles persist in session.",
      "Export: CSV/JSON/GPX/KML downloads from flight stats.",
      "Logging: comprehensive debug logging via tauri-plugin-log (console + file) at Debug level. Parser logs file details, frame processing stats, skip reasons, and timing. Commands log elapsed time. Queries log row counts and timing.",
      "Crash protection: parser uses spawn_blocking + catch_unwind + timeout. Telemetry validated for GPS range, finite values, altitude/speed sanity.",
      "UI polish: theme variables, tag styling for device/serials, modal scrollbar lock.",
      "Data safety: DB backup, corruption handling, telemetry rebuild when column order mismatches."
    ],
    "out_of_scope": [
      "Cloud sync",
      "Server-side processing",
      "External analytics pipelines"
    ]
  },
  "structure": {
    "frontend": {
      "root": "src",
      "key_components": [
        "src/components/dashboard/Dashboard.tsx",
        "src/components/dashboard/FlightList.tsx",
        "src/components/dashboard/FlightStats.tsx",
        "src/components/dashboard/SettingsModal.tsx",
        "src/components/dashboard/Overview.tsx",
        "src/components/charts/TelemetryCharts.tsx",
        "src/components/map/FlightMap.tsx"
      ],
      "styles": [
        "src/index.css",
        "tailwind.config.js"
      ],
      "state_store": "src/stores/flightStore.ts",
      "types": "src/types/index.ts"
    },
    "backend": {
      "root": "src-tauri/src",
      "key_files": [
        "src-tauri/src/main.rs",
        "src-tauri/src/database.rs",
        "src-tauri/src/parser.rs",
        "src-tauri/src/models.rs",
        "src-tauri/src/api.rs"
      ]
    },
    "config": {
      "env": ".env (DJI API key via env var)",
      "local_config": "config.json (API key stored locally)",
      "context_file": ".context (machine-readable project context, gitignored)"
    }
  },
  "data_flow": {
    "import": [
      "User selects file(s) in UI",
      "Tauri command parses using dji-log-parser (spawn_blocking + catch_unwind + 40s timeout)",
      "Parser validates telemetry: skips corrupt frames, filters GPS (lat ±90, lon ±180), clamps altitude (<10km) and speed (<100 m/s)",
      "Metadata inserted into flights table",
      "Telemetry bulk inserted with DuckDB Appender (column order enforced)",
      "If telemetry insert fails, flight metadata is cleaned up automatically",
      "UI refreshes flight list and telemetry views"
    ],
    "telemetry_query": [
      "UI requests telemetry for flight via selectFlight()",
      "Store checks if same flight already selected (skip if so)",
      "Store checks _flightDataCache Map (LRU, max 10 entries) for instant hit",
      "On cache miss: Tauri get_flight_data uses get_flight_by_id() for O(1) lookup",
      "Telemetry/track queries skip COUNT(*) when point_count known from flight metadata",
      "DB returns raw data or downsampled to ~5000 points (1s buckets)",
      "Response cached in frontend store for future re-selection",
      "Frontend converts units and renders charts/maps"
    ]
  },
  "recent_changes": {
    "filters": {
      "flight_list": "Added date range popup, drone and battery filters with compact styling.",
      "date_picker": "Modern range picker (react-day-picker), future dates disabled, themed styling."
    },
    "flight_list": {
      "search_sort": "Search by partial title and sort by date/name with direction toggle.",
      "simplified_layout": "Replaced complex flight entries (hover effects, group transitions, icon rows) with a simple compact list. Each entry shows flight name, small inline rename (sky-400) and delete (red-400) icons, and a single subtitle line with date, duration, and distance separated by dots. Double-click on name also triggers rename. All functionality preserved (rename with Save/Cancel, delete with Yes/No confirmation, selection highlight, keyboard access).",
      "removed_icons": "Removed ClockIcon and DistanceIcon components (stats are now inline text).",
      "flex_height_fix": "Changed FlightList root from h-full to flex-1 min-h-0, and Dashboard wrapper to flex-1 min-h-0 flex flex-col, fixing height resolution chain that caused double text rendering."
    },
    "ui": {
      "selects": "Custom select styling to match dark/light themes, consistent background and text.",
      "collapsed_sidebar": "Collapsed width increased by ~20%.",
      "overview_filters": "Sticky filter bar on overview; content scrolls independently.",
      "overview_sidebar": "Flight list remains visible in overview; controls hidden.",
      "labels": "Device/SN/Battery tags stylized as pills.",
      "charts": "Light theme gridlines, auto axis ranges with rounding, right padding to avoid label clipping, RC ticks fixed (0/50/100).",
      "battery_chart": "Low battery region shown as semi-transparent red band; voltage plotted on hidden axis, temp labeled on right.",
      "gps_chart": "Height increased to 200px.",
      "delete_confirm": "Inline confirmations for single-flight delete and delete-all logs in Settings.",
      "loading_spinner": "Changed loading spinner from border-dji-primary to border-sky-400 (light blue) for visibility in both light and dark modes."
    },
    "exports": {
      "flight_stats": "Export dropdown for CSV/JSON/GPX/KML with derived distance-to-home in JSON/CSV."
    },
    "charts": {
      "telemetry": "Added RC uplink/downlink, distance-to-home, and velocity XYZ panels.",
      "theme_aware": "Chart base config is now theme-aware (createBaseChartConfig). Axis colors, label colors, tooltip bg/border/text, data zoom styling, and data background all adapt to light/dark mode."
    },
    "map": {
      "smoothing": "Raw GPS track smoothed with Catmull-Rom spline interpolation (resolution=4) for natural curves.",
      "path": "deck.gl PathLayer with per-segment gradient coloring, 4px width, shadow/outline layer (7px, black 40% opacity). Path data includes meta per segment (height, speed, distance, progress, lat, lng).",
      "color_by": "Dropdown with 4 modes: Progress (yellow→red), Height (green→yellow→red), Speed (blue→cyan→green→yellow→red), Distance from Home (green→yellow→orange→red). Multi-stop ramps with lerp interpolation.",
      "markers": "Start (pulsing yellow dot + label), End (red circle with landing arrow + label), Home (blue 'H' circle). All use react-map-gl Marker components.",
      "tooltip": "Hover tooltip shows Height (m), Speed (km/h), Dist. Home (m/km), Lat, Lng. Toggleable via controls panel (default on, session-persisted). Uses manual deck.pickObject() on parent div mousemove with pickingRadius=12 — DeckGL overlay keeps pointer-events:none so map pan/rotate/zoom remain fully interactive.",
      "toggles": "3D Terrain, Satellite, Tooltip — all session-persisted via sessionStorage.",
      "styles": "Satellite basemap (ArcGIS tiles), dark/light Carto basemaps, 3D terrain (MapLibre DEM)."
    },
    "logging": {
      "tauri": "tauri-plugin-log enabled at LevelFilter::Debug; console + log file targets.",
      "log_dir": "~/.local/share/com.dji-logviewer.app/logs/",
      "parser_logging": "File size/hash, version/product/serial info, frame counts, per-frame skip reasons (corrupt, no-GPS, out-of-range, alt/speed clamped), parse completion summary with timing.",
      "command_logging": "All Tauri command handlers log timing (elapsed ms), parameters, and result counts.",
      "database_logging": "Query timing for get_all_flights, get_overview_stats, delete_flight, delete_all_flights, update_flight_name.",
      "error_logging": "Timeout/panic errors in parser logged with details; keychain fetch failures; telemetry insert cleanup."
    },
    "raw_logs_removed": {
      "description": "Removed raw_logs feature that copied encrypted binary .txt files to app data dir (served no purpose). Removed archive_log_file from parser, get_raw_logs_dir command, raw_logs dir creation, and all references."
    },
    "crash_protection": {
      "parser": "DJILog::from_bytes and frames() run in spawn_blocking with catch_unwind and 40s timeout. Panics are caught and returned as ParserError::Panic.",
      "telemetry_validation": "extract_telemetry skips frames with non-finite values, GPS outside ±90/±180, altitude >10km, speed >100 m/s. Counters track skip reasons.",
      "frontend": "selectFlight wrapped in try/catch; localStorage cleared on repeated crash to break crash loops."
    },
    "startup": {
      "selection": "Last selected flight is persisted; no auto-load on fresh start unless a last selection exists.",
      "logging": "UI renders without waiting for log plugin initialization."
    },
    "api_key": {
      "cache": "API key cache updates immediately after saving (no restart needed).",
      "default": "Default key is used when no key is configured; users can override in Settings."
    },
    "light_mode": {
      "text_overrides": "Light mode overrides for text-gray-300/400/500/100/white and border-gray-700 use !important in index.css.",
      "hover_overrides": "Light mode hover overrides for hover:bg-gray-700/30, hover:bg-gray-700/40, hover:bg-gray-700, hover:text-white, hover:text-gray-200.",
      "scrollbar": "Light mode scrollbar styling (track #f1f5f9, thumb #cbd5e1) plus scrollbar-color on body.theme-light."
    },
    "performance": {
      "get_flight_by_id": "Added get_flight_by_id() to database.rs for single-row WHERE id=? lookup, replacing get_all_flights() scan in get_flight_data.",
      "skip_count_queries": "get_flight_telemetry() and get_flight_track() now accept optional known_point_count parameter from flight metadata, skipping redundant SELECT COUNT(*) queries.",
      "frontend_cache": "Zustand store caches up to 10 flight data responses in _flightDataCache Map. Re-selecting a previously viewed flight serves data instantly from memory.",
      "skip_same_flight": "selectFlight() returns immediately if the requested flight is already selected and data is loaded."
    }
  },
  "behavior": {
    "theme": "Global theme (system/light/dark) applied to body, maps, and charts.",
    "units": "Metric/Imperial conversions for speed, height, distance.",
    "x_axis_ticks": "Shared time axis labels aligned across charts; labels rotated and overlap hidden."
  },
  "data_model": {
    "flight": {
      "fields": [
        "id",
        "fileName",
        "displayName",
        "startTime",
        "durationSecs",
        "totalDistance",
        "droneModel",
        "droneSerial",
        "aircraftName",
        "batterySerial"
      ]
    },
    "telemetry": {
      "fields": [
        "time",
        "latitude",
        "longitude",
        "height",
        "vpsHeight",
        "altitude",
        "speed",
        "velocityX",
        "velocityY",
        "velocityZ",
        "battery",
        "batteryVoltage",
        "batteryTemp",
        "pitch",
        "roll",
        "yaw",
        "rcSignal",
        "rcUplink",
        "rcDownlink",
        "satellites",
        "distanceToHome"
      ]
    }
  },
  "database": {
    "path": "~/.local/share/com.dji-logviewer.app/flights.db",
    "tables": {
      "flights": [
        "id",
        "file_name",
        "display_name",
        "file_hash",
        "drone_model",
        "drone_serial",
        "aircraft_name",
        "battery_serial",
        "start_time",
        "end_time",
        "duration_secs",
        "total_distance",
        "max_altitude",
        "max_speed",
        "home_lat",
        "home_lon",
        "point_count",
        "imported_at",
        "notes"
      ],
      "telemetry": [
        "flight_id",
        "timestamp_ms",
        "latitude",
        "longitude",
        "altitude",
        "height",
        "vps_height",
        "altitude_abs",
        "speed",
        "velocity_x",
        "velocity_y",
        "velocity_z",
        "pitch",
        "roll",
        "yaw",
        "gimbal_pitch",
        "gimbal_roll",
        "gimbal_yaw",
        "battery_percent",
        "battery_voltage",
        "battery_current",
        "battery_temp",
        "flight_mode",
        "gps_signal",
        "satellites",
        "rc_signal",
        "rc_uplink",
        "rc_downlink"
      ],
      "keychains": [
        "serial_number",
        "encryption_key",
        "fetched_at"
      ]
    },
    "notes": [
      "Telemetry table column order is enforced; if mismatched it rebuilds automatically.",
      "Bulk inserts use DuckDB Appender matching the exact column order above.",
      "Downsampling occurs when telemetry points exceed ~5000 (1s buckets).",
      "Map track altitude uses COALESCE(height, vps_height, altitude) for relative 3D paths.",
      "App data dir structure: flights.db + keychains/ (no raw_logs — removed).",
      "Failed telemetry inserts trigger automatic flight metadata cleanup."
    ]
  },
  "parser": {
    "version": "dji-log-parser v0.5.7",
    "inputs": "DJI .dat/.txt logs",
    "outputs": [
      "Flight metadata (aircraft name, drone model/serial, battery serial, start/end, duration)",
      "Telemetry arrays (time, position, orientation, battery, RC, GPS)"
    ],
    "notes": [
      "Height uses OSD height when available; VPS height stored separately.",
      "Altitude fallback uses altitude if height is missing.",
      "Display name defaults to filename; can be edited in UI.",
      "Corrupt frames (non-finite lat/lon/alt/speed) are skipped with logging.",
      "GPS coordinates outside ±90 lat / ±180 lon are treated as out-of-range and excluded.",
      "Altitude/height values >10km and speed >100 m/s are clamped to None.",
      "V13+ logs require keychain decryption; API key fetched from config or default.",
      "File deduplication via SHA256 hash prevents re-importing the same log.",
      "Parsing runs in spawn_blocking with catch_unwind and 40s timeout for crash safety."
    ]
  },
  "commands": {
    "frontend": [
      "npm run dev",
      "npm run build",
      "npm run preview"
    ],
    "tauri": [
      "npm run tauri",
      "npm run tauri:nowatch"
    ]
  },
  "ui": {
    "themes": "CSS variables in src/index.css; body classes theme-light/theme-dark. Light mode uses !important overrides for text colors, hover backgrounds, and scrollbar styling.",
    "filters": "Flight list uses date range popover (react-day-picker), drone and battery selects.",
    "flight_list": "Simple compact list with always-visible rename (sky-400) and delete (red-400) icons. Subtitle shows date · duration · distance. Double-click name to rename. No hover effects or transitions.",
    "charts": "ECharts with synced zoom; reset zoom button; map + charts resizable panels; tooltip header uses pill capsules for duration/time; attitude panel taller; RC ticks fixed to 0/50/100. Theme-aware base config adapts all visual elements to light/dark mode.",
    "map": "MapLibre terrain with global theme styling. deck.gl overlay with spline-smoothed color-by gradient path, shadow layer, start/end/home markers, hover tooltip (manual picking, pointer-events passthrough).",
    "loading": "Spinner uses border-sky-400 for both-mode visibility."
  },
  "known_issues": [
    "If import fails with column order mismatch, telemetry table rebuild should correct it.",
    "Node engine warnings may appear for some transient packages; app still runs.",
    "Older DJI logs (pre-2020) may produce garbage telemetry values; parser validation filters these out."
  ],
  "notes": {
    "api_key": "Stored locally in config.json; never sent except to DJI API.",
    "db_location": "App data dir under ~/.local/share/com.dji-logviewer.app (flights.db + keychains/)",
    "log_location": "Log files under ~/.local/share/com.dji-logviewer.app/logs/",
    "checkpoint": "git tag checkpoint-2026-02-08",
    "git": {
      "branch": "master",
      "tags": ["checkpoint-2026-02-06", "checkpoint-2026-02-08"]
    }
  }
}
